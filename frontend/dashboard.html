<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>My Dashboard - AccSwap</title>

    <!-- Immediate theme application to prevent FOUC -->
    <script>
    if (localStorage.getItem("theme") === "dark" || (!localStorage.getItem("theme") && window.matchMedia("(prefers-color-scheme: dark)").matches)) {
        document.documentElement.classList.add("dark");
    } else {
        document.documentElement.classList.remove("dark");
    }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <style>
        .modal { display: none; }
        .modal.active { display: flex; }
        #notification {
            transition: transform 0.28s ease-in-out, opacity 0.28s ease-in-out;
            transform: translateY(200%);
            opacity: 0;
        }
        #notification.active {
            transform: translateY(0);
            opacity: 1;
        }
        .glass { background: rgba(255,255,255,0.12); backdrop-filter: blur(8px); }
        .btn-animate { transition: transform .22s cubic-bezier(.2,.9,.2,1), box-shadow .2s; }
        .btn-animate:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 8px 24px rgba(14,165,233,0.12); }
        
        /* Timeline Animation */
        .progress-bar-fill { transition: width 1s ease-out; }
    </style>
</head>
<body class="bg-gradient-to-br from-sky-50 via-purple-50 to-pink-50 dark:from-slate-950 dark:via-slate-900 dark:to-slate-800 text-slate-800 dark:text-slate-200 transition-colors duration-500 min-h-screen">

    <!-- NAV -->
    <nav class="glass shadow-md sticky top-0 z-50 border-b border-slate-200/40 dark:border-slate-700/40">
        <div class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a class="text-2xl font-extrabold bg-gradient-to-r from-sky-500 to-purple-500 bg-clip-text text-transparent" href="index.html">AccSwap</a>
            <div class="flex items-center">
                <a href="index.html" class="px-4 py-2 text-slate-700 dark:text-slate-300 text-sm font-semibold hover:text-sky-500 dark:hover:text-sky-400 transition-colors">Back to Marketplace</a>
                 <!-- Theme Toggle -->
                <button id="theme-toggle" class="ml-4 p-2 rounded-lg text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-400">
                    <svg id="theme-toggle-dark-icon" class="hidden h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 10.607a1 1 0 010-1.414l.707-.707a1 1 0 111.414 1.414l-.707.707a1 1 0 01-1.414 0zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                </button>
            </div>
        </div>
    </nav>

    <!-- MAIN -->
    <main class="container mx-auto px-6 py-12">
        <h1 class="text-4xl font-extrabold text-slate-800 dark:text-white mb-8">My Purchase History</h1>
        
        <div class="bg-white dark:bg-slate-800/50 p-6 sm:p-8 rounded-xl shadow-lg border border-slate-200/80 dark:border-slate-700/80">
            <h2 class="text-2xl font-bold text-slate-800 dark:text-white mb-6 border-b border-slate-200 dark:border-slate-700 pb-4">Transactions</h2>
            <div id="purchases-container">
                <p class="text-slate-500 dark:text-slate-400">Loading your purchase history...</p>
            </div>
        </div>
    </main>

    <!-- TOAST -->
    <div id="notification" class="fixed bottom-5 right-5 p-4 rounded-xl shadow-2xl text-white font-semibold z-[100]">
        <p id="notification-message"></p>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_BASE_URL = 'http://127.0.0.1:8000';
        const purchasesContainer = document.getElementById('purchases-container');
        const token = localStorage.getItem('accessToken');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const lightIcon = document.getElementById('theme-toggle-light-icon');
        const darkIcon = document.getElementById('theme-toggle-dark-icon');
        const notificationDiv = document.getElementById('notification');
        const notificationMessage = document.getElementById('notification-message');

        // Security Check: If the user is not logged in, redirect them to the homepage.
        if (!token) {
            window.location.href = './index.html'; 
            return; 
        }

        const showNotification = (message, type = 'success') => {
            if (!notificationDiv || !notificationMessage) return;
            notificationMessage.textContent = message;
            notificationDiv.className = 'fixed bottom-5 right-5 p-4 rounded-xl shadow-2xl text-white font-semibold z-[100]';
            notificationDiv.classList.add(type === 'success' ? 'bg-emerald-500' : 'bg-red-500');
            notificationDiv.classList.add('active');
            setTimeout(() => { notificationDiv.classList.remove('active'); }, 3000);
        };

        async function fetchPurchases() {
            try {
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                };

                const response = await fetch(`${API_BASE_URL}/api/transactions/`, { headers });
                
                if (response.status === 401) {
                    throw new Error('Your session has expired. Please log in again.');
                }
                if (!response.ok) {
                    throw new Error('Failed to fetch your purchases.');
                }
                
                const transactions = await response.json();
                renderPurchases(transactions);
            } catch (error) {
                console.error("Fetch Purchases Error:", error);
                purchasesContainer.innerHTML = `<p class="text-red-500 text-center">${error.message}</p>`;
            }
        }

        // --- TIMELINE VISUALIZER LOGIC ---
        function renderTimeline(status) {
            const stages = [
                { id: 'pending', label: 'Payment' },
                { id: 'admin_review', label: 'Secured' },
                { id: 'delivery_pending', label: 'Verified' },
                { id: 'complete', label: 'Released' }
            ];

            let currentIndex = -1;
            if (status === 'pending') currentIndex = 0;
            else if (status === 'admin_review') currentIndex = 1;
            else if (status === 'delivery_pending') currentIndex = 2;
            else if (status === 'complete') currentIndex = 3;
            else if (status === 'cancelled' || status === 'disputed') currentIndex = -2; 

            if (currentIndex === -2) {
                return `<div class="w-full bg-red-100 text-red-600 p-3 rounded-lg text-center font-bold text-sm">Transaction Cancelled / Disputed</div>`;
            }

            const widthPercent = (currentIndex / (stages.length - 1)) * 100;

            let stepsHtml = '';
            stages.forEach((stage, idx) => {
                const isActive = idx <= currentIndex;
                const isCurrent = idx === currentIndex;
                
                let circleClass = isActive 
                    ? "bg-emerald-500 border-emerald-500 text-white shadow-lg shadow-emerald-500/30 scale-110" 
                    : "bg-slate-200 border-slate-300 text-slate-400 dark:bg-slate-700 dark:border-slate-600";
                
                if (isCurrent) circleClass += " animate-pulse ring-4 ring-emerald-100 dark:ring-emerald-900";

                const textClass = isActive 
                    ? "text-emerald-600 dark:text-emerald-400 font-bold" 
                    : "text-slate-400 dark:text-slate-500 font-medium";

                stepsHtml += `
                    <div class="relative z-10 flex flex-col items-center flex-1">
                        <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs transition-all duration-500 ${circleClass}">
                            ${isActive ? '‚úì' : idx + 1}
                        </div>
                        <div class="mt-2 text-[10px] sm:text-xs text-center uppercase tracking-wide transition-colors duration-500 ${textClass}">
                            ${stage.label}
                        </div>
                    </div>
                `;
            });

            return `
                <div class="relative w-full mt-6 mb-2 px-2">
                    <div class="absolute top-4 left-0 w-full h-1 bg-slate-200 dark:bg-slate-700 rounded-full -z-0"></div>
                    <div class="absolute top-4 left-0 h-1 bg-emerald-500 rounded-full -z-0 progress-bar-fill" style="width: ${widthPercent}%"></div>
                    <div class="flex justify-between w-full">
                        ${stepsHtml}
                    </div>
                </div>
            `;
        }

        function renderPurchases(transactions) {
            if (!transactions || transactions.length === 0) {
                purchasesContainer.innerHTML = `<p class="text-center text-slate-500 dark:text-slate-400 py-10">You have not made any purchases yet.</p>`;
                return;
            }

            let html = '<div class="space-y-6">';
            transactions.forEach(tx => {
                const handle = tx.listing ? tx.listing.handle : 'N/A';
                const platform = tx.listing ? tx.listing.platform : 'N/A';
                const timelineHtml = renderTimeline(tx.status);
                
                html += `
                    <div class="bg-white dark:bg-slate-900 rounded-xl p-6 border border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-md transition">
                        <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                            <div>
                                <p class="font-bold text-lg text-slate-800 dark:text-white">${platform} Account</p>
                                <p class="text-sky-500 font-medium">@${handle}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xl font-bold text-slate-800 dark:text-white">‚Çπ${tx.amount}</p>
                                <p class="text-xs text-slate-500 dark:text-slate-400">ID: #${tx.id}</p>
                            </div>
                        </div>

                        <!-- TIMELINE VISUALIZER -->
                        <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-lg mb-4">
                            ${timelineHtml}
                        </div>
                        
                        <div class="flex justify-between items-center pt-2">
                            <div class="text-xs text-slate-500 dark:text-slate-400">
                                ${tx.status === 'delivery_pending' ? '‚úÖ Verification complete. Credentials ready.' : 
                                  tx.status === 'admin_review' ? '‚ÑπÔ∏è Admin is verifying account details.' : 
                                  tx.status === 'pending' ? '‚è≥ Waiting for payment confirmation.' : ''}
                            </div>

                            ${tx.status === 'delivery_pending' ? 
                                `<button class="view-creds-btn mt-2 bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md btn-animate flex items-center gap-2" data-tx-id="${tx.id}">
                                    <span>üîì View Password</span>
                                </button>` : ''
                            }
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            purchasesContainer.innerHTML = html;
        }
        
        purchasesContainer.addEventListener('click', async (e) => {
            const btn = e.target.closest('.view-creds-btn');
            if (btn) {
                const txId = btn.dataset.txId;
                try {
                    const response = await fetch(`${API_BASE_URL}/api/transactions/${txId}/credentials/`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error);
                    alert(`üîê SECURE CREDENTIALS\n\nNew Password: ${data.new_password}\n\nPLEASE NOTE: Log in immediately and change this password.`);
                } catch (error) {
                    showNotification(`Error: ${error.message}`, 'error');
                }
            }
        });

        function applyTheme() {
             if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                darkIcon.classList.add('hidden');
                lightIcon.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                lightIcon.classList.add('hidden');
                darkIcon.classList.remove('hidden');
            }
        }

        themeToggleBtn.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            applyTheme();
        });

        // --- Initial Load ---
        applyTheme();
        fetchPurchases();
    });
    </script>
</body>
</html>